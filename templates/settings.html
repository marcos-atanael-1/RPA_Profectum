{% extends "base.html" %}

{% block title %}Configura√ß√µes - RPA Profectum{% endblock %}

{% block content %}
<style>
    .settings-layout {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
    }
    
    .settings-content {
        display: flex;
        flex: 1;
        gap: 20px;
        align-items: flex-start;
    }
    
    .settings-main {
        flex: 2;
        min-width: 0;
    }
    
    .settings-preview {
        flex: 1;
        position: sticky;
        top: 20px;
        max-height: calc(100vh - 40px);
        overflow-y: auto;
        min-width: 300px;
    }
    
    @media (max-width: 992px) {
        .settings-content {
            flex-direction: column;
        }
        
        .settings-preview {
            position: static;
            margin-top: 20px;
            max-height: none;
        }
    }
</style>

<div class="fade-in settings-layout">
    <!-- Page Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h3 mb-0">‚öôÔ∏è Configura√ß√µes do Sistema</h1>
                <p class="text-muted mt-1">Personalize a apar√™ncia e configura√ß√µes gerais</p>
            </div>
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Settings Content -->
    <div class="settings-content">
        <!-- Main Content -->
        <div class="settings-main">
            <!-- Tabs Navigation -->
            <ul class="nav nav-tabs mb-4" id="settingsTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="system-tab" data-bs-toggle="tab" data-bs-target="#system" type="button" role="tab">
                        üé® Sistema
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="login-tab" data-bs-toggle="tab" data-bs-target="#login" type="button" role="tab">
                        üîê P√°gina de Login
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="settingsTabContent">
                <!-- Sistema Tab -->
                <div class="tab-pane fade show active" id="system" role="tabpanel">
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h5 class="card-title mb-0">üé® Personaliza√ß√£o do Sistema</h5>
                        </div>
                <div class="card-body">
                    <form method="POST" id="settingsForm">
                        <!-- Nome do Sistema -->
                        <div class="mb-4">
                            <label for="system_name" class="form-label">Nome do Sistema</label>
                            <input type="text" class="form-control" id="system_name" name="system_name" 
                                   value="{{ settings.system_name }}" placeholder="RPA Profectum">
                            <small class="text-muted">Nome que aparece na sidebar e t√≠tulos</small>
                        </div>

                        <!-- Cor Prim√°ria -->
                        <div class="mb-4">
                            <label for="primary_color" class="form-label">Cor Prim√°ria</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <input type="color" class="form-control form-control-color" 
                                           id="primary_color" name="primary_color" 
                                           value="{{ settings.primary_color }}" title="Escolher cor">
                                </div>
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="primary_color_text" 
                                           value="{{ settings.primary_color }}" placeholder="#2563eb">
                                </div>
                            </div>
                            <small class="text-muted">Cor usada em bot√µes, links e elementos de destaque</small>
                            
                            <!-- Cores Predefinidas -->
                            <div class="mt-3">
                                <label class="form-label">Cores Predefinidas:</label>
                                <div class="d-flex gap-2 flex-wrap">
                                    <button type="button" class="btn p-2 color-preset" 
                                            style="background-color: #2563eb; width: 40px; height: 40px; border-radius: 8px;" 
                                            data-color="#2563eb" title="Azul (Padr√£o)"></button>
                                    <button type="button" class="btn p-2 color-preset" 
                                            style="background-color: #10b981; width: 40px; height: 40px; border-radius: 8px;" 
                                            data-color="#10b981" title="Verde"></button>
                                    <button type="button" class="btn p-2 color-preset" 
                                            style="background-color: #f59e0b; width: 40px; height: 40px; border-radius: 8px;" 
                                            data-color="#f59e0b" title="Amarelo"></button>
                                    <button type="button" class="btn p-2 color-preset" 
                                            style="background-color: #ef4444; width: 40px; height: 40px; border-radius: 8px;" 
                                            data-color="#ef4444" title="Vermelho"></button>
                                    <button type="button" class="btn p-2 color-preset" 
                                            style="background-color: #8b5cf6; width: 40px; height: 40px; border-radius: 8px;" 
                                            data-color="#8b5cf6" title="Roxo"></button>
                                    <button type="button" class="btn p-2 color-preset" 
                                            style="background-color: #06b6d4; width: 40px; height: 40px; border-radius: 8px;" 
                                            data-color="#06b6d4" title="Ciano"></button>
                                    <button type="button" class="btn p-2 color-preset" 
                                            style="background-color: #84cc16; width: 40px; height: 40px; border-radius: 8px;" 
                                            data-color="#84cc16" title="Lima"></button>
                                    <button type="button" class="btn p-2 color-preset" 
                                            style="background-color: #f97316; width: 40px; height: 40px; border-radius: 8px;" 
                                            data-color="#f97316" title="Laranja"></button>
                                </div>
                            </div>
                        </div>

                        <!-- Logo -->
                        <div class="mb-4">
                            <label class="form-label">Logo do Sistema</label>
                            
                            <!-- Tipo de Logo -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="logo_type" 
                                               id="logo_icon" value="icon" 
                                               {{ 'checked' if settings.logo_type == 'icon' else '' }}>
                                        <label class="form-check-label" for="logo_icon">
                                            ü§ñ √çcone Padr√£o
                                        </label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="logo_type" 
                                               id="logo_url" value="url" 
                                               {{ 'checked' if settings.logo_type == 'url' else '' }}>
                                        <label class="form-check-label" for="logo_url">
                                            üåê URL da Imagem
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- URL da Logo -->
                            <div class="logo-url-section" style="{{ 'display: none;' if settings.logo_type == 'icon' else '' }}">
                                <input type="url" class="form-control" id="logo_url_input" name="logo_url" 
                                       value="{{ settings.logo_url }}" placeholder="https://exemplo.com/logo.png">
                                <small class="text-muted">Cole a URL de uma imagem (PNG, JPG, SVG)</small>
                                
                                <!-- Preview da Logo -->
                                <div class="mt-3" id="logo_preview_section" style="display: none;">
                                    <label class="form-label">Preview:</label>
                                    <div class="border rounded p-3 bg-light">
                                        <img id="logo_preview" src="" alt="Preview da Logo" 
                                             style="max-width: 200px; max-height: 80px; object-fit: contain;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bot√µes -->
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-lg me-1"></i>
                                Salvar Configura√ß√µes
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="location.reload()">
                                <i class="bi bi-arrow-clockwise me-1"></i>
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Preview -->
        <div class="settings-preview" id="previewCard">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="card-title mb-0">üëÅÔ∏è Preview do Sistema</h5>
                </div>
                <div class="card-body">
                    <div class="preview-sidebar border rounded p-3" style="background-color: white;">
                        <div class="d-flex align-items-center mb-3" id="logo_preview_sidebar">
                            <div class="logo-icon me-2">
                                <i class="bi bi-robot text-primary fs-4"></i>
                            </div>
                            <div class="logo-text">
                                <div class="fw-bold text-primary" id="preview_system_name">{{ settings.system_name }}</div>
                                <small class="text-muted">Sistema</small>
                            </div>
                        </div>
                        
                        <div class="preview-elements">
                            <div class="btn btn-primary btn-sm mb-2 w-100" id="preview_button">Bot√£o Primary</div>
                            <div class="nav-link active" id="preview_nav" style="background-color: var(--primary-color);">
                                <i class="bi bi-house me-2"></i>Dashboard
                            </div>
                        </div>
                    </div>
                    
                    <small class="text-muted mt-2 d-block">
                        Este √© um preview de como ficar√° a apar√™ncia do sistema com suas configura√ß√µes.
                    </small>
                </div>
            </div>
        </div>
    </div>
                
                <!-- Login Tab -->
                <div class="tab-pane fade" id="login" role="tabpanel">
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h5 class="card-title mb-0">üîê Personaliza√ß√£o da P√°gina de Login</h5>
                        </div>
                        <div class="card-body">
                            <form method="POST" id="loginSettingsForm">
                                <input type="hidden" name="settings_type" value="login">
                                
                                <!-- Background da P√°gina de Login -->
                                <div class="mb-4">
                                    <label class="form-label">Fundo da P√°gina de Login</label>
                                    
                                    <div class="row mb-3">
                                        <div class="col-12">
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="login_bg_type" 
                                                       id="login_bg_color" value="color" 
                                                       {{ 'checked' if settings.get('login_bg_type', 'color') == 'color' else '' }}>
                                                <label class="form-check-label" for="login_bg_color">
                                                    üé® Cor S√≥lida
                                                </label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="login_bg_type" 
                                                       id="login_bg_gradient" value="gradient" 
                                                       {{ 'checked' if settings.get('login_bg_type') == 'gradient' else '' }}>
                                                <label class="form-check-label" for="login_bg_gradient">
                                                    üåà Gradiente
                                                </label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="login_bg_type" 
                                                       id="login_bg_image" value="image" 
                                                       {{ 'checked' if settings.get('login_bg_type') == 'image' else '' }}>
                                                <label class="form-check-label" for="login_bg_image">
                                                    üñºÔ∏è Imagem
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Cor S√≥lida -->
                                    <div class="login-bg-color-section mb-3">
                                        <label for="login_bg_color_value" class="form-label">Cor de Fundo</label>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <input type="color" class="form-control form-control-color" 
                                                       id="login_bg_color_value" name="login_bg_color" 
                                                       value="{{ settings.get('login_bg_color', '#f8fafc') }}">
                                            </div>
                                            <div class="col-md-6">
                                                <input type="text" class="form-control" id="login_bg_color_text" 
                                                       value="{{ settings.get('login_bg_color', '#f8fafc') }}">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Gradiente -->
                                    <div class="login-bg-gradient-section mb-3" style="display: none;">
                                        <label class="form-label">Cores do Gradiente</label>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">Cor 1</label>
                                                <input type="color" class="form-control form-control-color" 
                                                       name="login_gradient_color1" 
                                                       value="{{ settings.get('login_gradient_color1', '#2563eb') }}">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Cor 2</label>
                                                <input type="color" class="form-control form-control-color" 
                                                       name="login_gradient_color2" 
                                                       value="{{ settings.get('login_gradient_color2', '#1d4ed8') }}">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Imagem de Fundo -->
                                    <div class="login-bg-image-section mb-3" style="display: none;">
                                        <label for="login_bg_image_url" class="form-label">URL da Imagem de Fundo</label>
                                        <input type="url" class="form-control" id="login_bg_image_url" 
                                               name="login_bg_image_url" 
                                               value="{{ settings.get('login_bg_image_url', '') }}" 
                                               placeholder="https://exemplo.com/background.jpg">
                                        <small class="text-muted">Recomendado: imagens em alta resolu√ß√£o (1920x1080 ou maior)</small>
                                    </div>
                                </div>

                                <!-- Altura da P√°gina de Login -->
                                <div class="mb-4">
                                    <label for="login_height" class="form-label">Altura da P√°gina</label>
                                    <select class="form-select" id="login_height" name="login_height">
                                        <option value="compact" {{ 'selected' if settings.get('login_height') == 'compact' else '' }}>Compacta</option>
                                        <option value="normal" {{ 'selected' if settings.get('login_height', 'normal') == 'normal' else '' }}>Normal</option>
                                        <option value="full" {{ 'selected' if settings.get('login_height') == 'full' else '' }}>Tela Cheia</option>
                                    </select>
                                    <small class="text-muted">Compacta = mais condensada, Normal = padr√£o, Tela Cheia = ocupa toda a tela</small>
                                </div>

                                <!-- T√≠tulo Personalizado -->
                                <div class="mb-4">
                                    <label for="login_title" class="form-label">T√≠tulo da P√°gina de Login</label>
                                    <input type="text" class="form-control" id="login_title" name="login_title" 
                                           value="{{ settings.get('login_title', 'Bem-vindo de volta!') }}" 
                                           placeholder="Bem-vindo de volta!">
                                    <small class="text-muted">Texto que aparece acima do formul√°rio de login</small>
                                </div>

                                <!-- Bot√µes -->
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-check-lg me-1"></i>
                                        Salvar Configura√ß√µes do Login
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="location.reload()">
                                        <i class="bi bi-arrow-clockwise me-1"></i>
                                        Cancelar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
{% endblock %}

{% block extra_js %}
<script>
    // Sincronizar color picker com text input
    const colorPicker = document.getElementById('primary_color');
    const colorText = document.getElementById('primary_color_text');
    
    colorPicker.addEventListener('input', function() {
        colorText.value = this.value;
        updatePreview();
    });
    
    colorText.addEventListener('input', function() {
        if (this.value.match(/^#[0-9A-F]{6}$/i)) {
            colorPicker.value = this.value;
            updatePreview();
        }
    });
    
    // Cores predefinidas
    document.querySelectorAll('.color-preset').forEach(button => {
        button.addEventListener('click', function() {
            const color = this.dataset.color;
            colorPicker.value = color;
            colorText.value = color;
            updatePreview();
        });
    });
    
    // Controle do tipo de logo
    document.querySelectorAll('input[name="logo_type"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const logoUrlSection = document.querySelector('.logo-url-section');
            logoUrlSection.style.display = this.value === 'url' ? 'block' : 'none';
            updateLogoPreview();
        });
    });
    
    // Preview da logo por URL
    const logoUrlInput = document.getElementById('logo_url_input');
    logoUrlInput.addEventListener('input', function() {
        updateLogoPreview();
    });
    
    // Preview do nome do sistema
    const systemNameInput = document.getElementById('system_name');
    systemNameInput.addEventListener('input', function() {
        document.getElementById('preview_system_name').textContent = this.value || 'RPA Profectum';
    });
    
         function updatePreview() {
         const color = colorPicker.value;
         document.documentElement.style.setProperty('--primary-color', color);
         
         // Criar cor transparente para o fundo dos √≠cones
         const lightColor = hexToRgba(color, 0.1);
         document.documentElement.style.setProperty('--primary-light', lightColor);
         
         // Atualizar elementos do preview
         document.getElementById('preview_button').style.backgroundColor = color;
         document.getElementById('preview_nav').style.backgroundColor = lightColor;
         document.getElementById('preview_nav').style.color = color;
     }
     
     function hexToRgba(hex, alpha) {
         const r = parseInt(hex.slice(1, 3), 16);
         const g = parseInt(hex.slice(3, 5), 16);
         const b = parseInt(hex.slice(5, 7), 16);
         return `rgba(${r}, ${g}, ${b}, ${alpha})`;
     }
    
    function updateLogoPreview() {
        const logoType = document.querySelector('input[name="logo_type"]:checked').value;
        const logoUrl = logoUrlInput.value;
        const previewSection = document.getElementById('logo_preview_section');
        const previewImg = document.getElementById('logo_preview');
        const sidebarLogo = document.getElementById('logo_preview_sidebar');
        
        if (logoType === 'url' && logoUrl) {
            // Mostrar preview da URL
            previewImg.src = logoUrl;
            previewSection.style.display = 'block';
            
            // Atualizar preview na sidebar
            sidebarLogo.innerHTML = `
                <div class="logo-icon me-2">
                    <img src="${logoUrl}" alt="Logo" style="width: 32px; height: 32px; object-fit: contain;">
                </div>
                <div class="logo-text">
                    <div class="fw-bold text-primary" id="preview_system_name">${systemNameInput.value || 'RPA Profectum'}</div>
                    <small class="text-muted">Sistema</small>
                </div>
            `;
        } else {
            // Esconder preview e usar √≠cone padr√£o
            previewSection.style.display = 'none';
            sidebarLogo.innerHTML = `
                <div class="logo-icon me-2">
                    <i class="bi bi-robot text-primary fs-4"></i>
                </div>
                <div class="logo-text">
                    <div class="fw-bold text-primary" id="preview_system_name">${systemNameInput.value || 'RPA Profectum'}</div>
                    <small class="text-muted">Sistema</small>
                </div>
            `;
        }
    }
    
    // Tratar erros de carregamento de imagem
    document.getElementById('logo_preview').addEventListener('error', function() {
        document.getElementById('logo_preview_section').style.display = 'none';
        alert('Erro ao carregar a imagem. Verifique se a URL est√° correta e acess√≠vel.');
    });
    
         // Controle das abas de configura√ß√£o do login
     document.querySelectorAll('input[name="login_bg_type"]').forEach(radio => {
         radio.addEventListener('change', function() {
             document.querySelector('.login-bg-color-section').style.display = 
                 this.value === 'color' ? 'block' : 'none';
             document.querySelector('.login-bg-gradient-section').style.display = 
                 this.value === 'gradient' ? 'block' : 'none';
             document.querySelector('.login-bg-image-section').style.display = 
                 this.value === 'image' ? 'block' : 'none';
         });
     });
     
     // Sincronizar color picker do login
     const loginColorPicker = document.getElementById('login_bg_color_value');
     const loginColorText = document.getElementById('login_bg_color_text');
     
     if (loginColorPicker && loginColorText) {
         loginColorPicker.addEventListener('input', function() {
             loginColorText.value = this.value;
         });
         
         loginColorText.addEventListener('input', function() {
             if (this.value.match(/^#[0-9A-F]{6}$/i)) {
                 loginColorPicker.value = this.value;
             }
         });
     }
     
     // Inicializar controles de login na primeira carga
     const selectedLoginBg = document.querySelector('input[name="login_bg_type"]:checked');
     if (selectedLoginBg) {
         selectedLoginBg.dispatchEvent(new Event('change'));
     }
     
     
      
      // Controle de visibilidade do preview
      document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
          tab.addEventListener('shown.bs.tab', function(event) {
              const targetTab = event.target.getAttribute('data-bs-target');
              const previewCard = document.getElementById('previewCard');
              
              if (targetTab === '#system') {
                  previewCard.style.display = 'block';
              } else {
                  previewCard.style.display = 'none';
              }
          });
      });
      
      // Inicializar preview
      updatePreview();
      updateLogoPreview();
  </script>
  {% endblock %} 