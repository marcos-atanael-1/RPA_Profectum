{% extends "base.html" %}

{% block title %}Recebimento NF - RPA Profectum{% endblock %}

{% block content %}
<div class="fade-in recebimento-container pt-2">
    <!-- Filtros -->
    <div class="card border-0 shadow-sm mb-3">
        <div class="card-header bg-transparent border-0 pb-0">
            <h6 class="card-title mb-0">
                <i class="bi bi-funnel me-2 text-primary"></i>
                Filtros
            </h6>
        </div>
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-3">
                    <label for="pedido" class="form-label fw-semibold">Pedido de Compra</label>
                    <input type="text" class="form-control" id="pedido" name="pedido" 
                           value="{{ pedido_filter }}" placeholder="Filtrar por pedido...">
                </div>
                <div class="col-md-3">
                    <label for="nf" class="form-label fw-semibold">Nota Fiscal</label>
                    <input type="text" class="form-control" id="nf" name="nf" 
                           value="{{ nf_filter }}" placeholder="Filtrar por NF...">
                </div>
                <div class="col-md-3">
                    <label for="status" class="form-label fw-semibold">Status</label>
                    <select class="form-select" id="status" name="status">
                        <option value="">Todos os status</option>
                        <option value="pendente" {% if status_filter == 'pendente' %}selected{% endif %}>Pendente</option>
                        <option value="processado" {% if status_filter == 'processado' %}selected{% endif %}>Processado</option>
                        <option value="erro" {% if status_filter == 'erro' %}selected{% endif %}>Erro</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end gap-2">
                    <button type="submit" class="btn btn-primary flex-fill">
                        <i class="bi bi-search me-2"></i>
                        Filtrar
                    </button>
                    <a href="{{ url_for('recebimento_nf') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-x-circle"></i>
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabela de Recebimentos -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent border-0 pb-0">
            <div class="d-flex justify-content-between align-items-center">
                <h6 class="card-title mb-0">
                    <i class="bi bi-table me-2 text-primary"></i>
                    Recebimentos Cadastrados
                </h6>
                {% if recebimentos.items %}
                <div class="text-muted small">
                    {{ recebimentos.total }} registro{{ 's' if recebimentos.total != 1 else '' }}
                </div>
                {% endif %}
            </div>
        </div>
        <div class="card-body p-0">
            {% if recebimentos.items %}
            <div class="table-responsive">
                <table class="table table-modern mb-0">
                    <thead>
                        <tr>
                            <th class="fw-semibold">ID</th>
                            <th class="fw-semibold">Pedido de Compra</th>
                            <th class="fw-semibold">Nota Fiscal</th>
                            <th class="fw-semibold">Chave de Acesso</th>
                            <th class="fw-semibold">Status</th>
                            <th class="fw-semibold">Criado por</th>
                            <th class="fw-semibold">Data/Hora</th>
                            <th class="fw-semibold text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for recebimento in recebimentos.items %}
                        <tr class="table-row-hover">
                            <td>
                                <span class="badge bg-light text-dark fw-semibold">#{{ recebimento.id }}</span>
                            </td>
                            <td>
                                <span class="fw-semibold text-dark">{{ recebimento.pedido_compra }}</span>
                            </td>
                            <td>
                                <span class="fw-semibold text-dark">{{ recebimento.nota_fiscal }}</span>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <code class="text-muted small bg-light px-2 py-1 rounded">
                                        {{ recebimento.chave_acesso[:20] }}...
                                    </code>
                                    <button type="button" class="btn btn-sm btn-link text-primary p-1 ms-2" 
                                            onclick="viewChaveCompleta('{{ recebimento.chave_acesso }}')" 
                                            title="Ver chave completa">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                            </td>
                            <td>
                                {% if recebimento.status == 'pendente' %}
                                <span class="status-badge status-pending">
                                    <i class="bi bi-clock me-1"></i>
                                    Pendente
                                </span>
                                {% elif recebimento.status == 'processado' %}
                                <span class="status-badge status-completed">
                                    <i class="bi bi-check-circle me-1"></i>
                                    Processado
                                </span>
                                {% elif recebimento.status == 'erro' %}
                                <span class="status-badge status-failed">
                                    <i class="bi bi-x-circle me-1"></i>
                                    Erro
                                </span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="user-avatar bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-2" 
                                         style="width: 32px; height: 32px;">
                                        <i class="bi bi-person text-primary"></i>
                                    </div>
                                    <span class="text-dark">{{ recebimento.creator.full_name if recebimento.creator else 'N/A' }}</span>
                                </div>
                            </td>
                            <td>
                                <div class="text-muted small">
                                    <div>{{ recebimento.created_at.strftime('%d/%m/%Y') if recebimento.created_at else 'N/A' }}</div>
                                    <div class="text-muted opacity-75">{{ recebimento.created_at.strftime('%H:%M') if recebimento.created_at else '' }}</div>
                                </div>
                            </td>
                            <td class="text-center">
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-outline-primary" 
                                            onclick="viewChaveCompleta('{{ recebimento.chave_acesso }}')" 
                                            title="Ver chave completa">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-danger" 
                                            onclick="deleteRecebimento({{ recebimento.id }})" 
                                            title="Excluir">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Paginação -->
            {% if recebimentos.pages > 1 %}
            <div class="d-flex justify-content-between align-items-center p-4 border-top bg-light bg-opacity-50">
                <div class="text-muted small">
                    Mostrando {{ recebimentos.per_page * (recebimentos.page - 1) + 1 }} a 
                    {{ recebimentos.per_page * recebimentos.page if recebimentos.page < recebimentos.pages else recebimentos.total }} 
                    de {{ recebimentos.total }} registros
                </div>
                <nav>
                    <ul class="pagination pagination-sm mb-0">
                        {% if recebimentos.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('recebimento_nf', page=recebimentos.prev_num, pedido=pedido_filter, nf=nf_filter, status=status_filter) }}">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>
                        {% endif %}
                        
                        {% for page_num in recebimentos.iter_pages() %}
                        {% if page_num %}
                        {% if page_num != recebimentos.page %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('recebimento_nf', page=page_num, pedido=pedido_filter, nf=nf_filter, status=status_filter) }}">{{ page_num }}</a>
                        </li>
                        {% else %}
                        <li class="page-item active">
                            <span class="page-link">{{ page_num }}</span>
                        </li>
                        {% endif %}
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">…</span>
                        </li>
                        {% endif %}
                        {% endfor %}
                        
                        {% if recebimentos.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('recebimento_nf', page=recebimentos.next_num, pedido=pedido_filter, nf=nf_filter, status=status_filter) }}">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}
            {% else %}
            <div class="text-center py-5">
                <div class="empty-state">
                    <div class="empty-icon bg-primary bg-opacity-10 rounded-circle mx-auto mb-4 d-flex align-items-center justify-content-center" 
                         style="width: 80px; height: 80px;">
                        <i class="bi bi-inbox display-4 text-primary opacity-75"></i>
                    </div>
                    <h4 class="text-dark mb-2">Nenhum recebimento encontrado</h4>
                    <p class="text-muted mb-4">Adicione o primeiro recebimento de NF clicando no botão abaixo.</p>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRecebimentoModal">
                        <i class="bi bi-plus-circle me-2"></i>
                        Adicionar Primeiro Recebimento
                    </button>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal Adicionar Recebimento -->
<div class="modal fade" id="addRecebimentoModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modern-modal">
            <div class="modal-header modern-modal-header">
                <div class="d-flex align-items-center">
                   
                    <div>
                        <h5 class="modal-title mb-0">Adicionar Recebimento</h5>
                        <small class="text-muted">Preencha os dados do recebimento da nota fiscal</small>
                    </div>
                </div>
                <button type="button" class="btn-close modern-btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('add_recebimento_nf') }}">
                <div class="modal-body modern-modal-body">
                    <div class="form-group-modern">
                        <label for="pedido_compra" class="form-label-modern">
                            Pedido de Compra
                        </label>
                        <input type="text" class="form-control-modern" id="pedido_compra" name="pedido_compra" 
                               required placeholder="Digite o número do pedido de compra">
                        
                    </div>
                    <div class="form-group-modern">
                        <label for="nota_fiscal" class="form-label-modern">
                            Nota Fiscal
                        </label>
                        <input type="text" class="form-control-modern" id="nota_fiscal" name="nota_fiscal" 
                               required placeholder="Digite o número da nota fiscal">
                        
                    </div>
                    <div class="form-group-modern">
                        <label for="chave_acesso" class="form-label-modern">
                            Chave de Acesso
                        </label>
                        <input type="text" class="form-control-modern" id="chave_acesso" name="chave_acesso" 
                               required maxlength="44" placeholder="Cole ou digite a chave de acesso de 44 caracteres">
                        <div class="input-helper">A chave deve conter exatamente 44 caracteres numéricos</div>
                    </div>
                </div>
                <div class="modal-footer modern-modal-footer">
                    <button type="button" class="btn-modern btn-secondary" data-bs-dismiss="modal">
                        Cancelar
                    </button>
                    <button type="submit" class="btn-modern btn-primary">
                        <i class="bi bi-check2 me-2"></i>
                        Adicionar Recebimento
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Ver Chave Completa -->
<div class="modal fade" id="chaveModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-semibold">
                    <i class="bi bi-key text-primary me-2"></i>
                    Chave de Acesso Completa
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-semibold">Chave de Acesso:</label>
                    <div class="input-group">
                        <input type="text" class="form-control font-monospace" id="chaveCompleta" readonly>
                        <button class="btn btn-outline-primary" type="button" onclick="copyChave()" title="Copiar chave">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                    <div class="form-text">Clique no botão para copiar a chave completa.</div>
                </div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">
                    Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.recebimento-container {
    padding: 0;
}

.table-row-hover {
    transition: all 0.2s ease;
}

.table-row-hover:hover {
    background-color: rgba(var(--bs-primary-rgb), 0.05) !important;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.user-avatar {
    transition: all 0.2s ease;
}

.table-row-hover:hover .user-avatar {
    background-color: var(--bs-primary) !important;
    background-opacity: 0.15 !important;
}

.empty-state {
    max-width: 400px;
    margin: 0 auto;
}

.empty-icon {
    transition: all 0.3s ease;
}

.empty-state:hover .empty-icon {
    transform: scale(1.05);
    background-color: var(--bs-primary) !important;
    background-opacity: 0.15 !important;
}

.status-badge {
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.375rem 0.75rem;
    border-radius: 0.5rem;
    display: inline-flex;
    align-items: center;
}

.status-pending {
    background-color: rgba(255, 193, 7, 0.1);
    color: #f59e0b;
    border: 1px solid rgba(255, 193, 7, 0.2);
}

.btn-group .btn {
    transition: all 0.2s ease;
}

.btn-group .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.pagination .page-link {
    border-radius: 0.5rem !important;
    margin: 0 2px;
    border: 1px solid rgba(0,0,0,0.1);
    color: var(--bs-primary);
    transition: all 0.2s ease;
}

.pagination .page-link:hover {
    background-color: var(--bs-primary);
    border-color: var(--bs-primary);
    color: white;
    transform: translateY(-1px);
}

.pagination .page-item.active .page-link {
    background-color: var(--bs-primary);
    border-color: var(--bs-primary);
    box-shadow: 0 2px 8px rgba(var(--bs-primary-rgb), 0.3);
}
</style>

<script>
function viewChaveCompleta(chave) {
    document.getElementById('chaveCompleta').value = chave;
    new bootstrap.Modal(document.getElementById('chaveModal')).show();
}

function copyChave() {
    const chaveInput = document.getElementById('chaveCompleta');
    chaveInput.select();
    chaveInput.setSelectionRange(0, 99999); // Para dispositivos móveis
    
    try {
        document.execCommand('copy');
        
        // Feedback visual melhorado
        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check text-success"></i>';
        btn.classList.add('btn-success');
        btn.classList.remove('btn-outline-primary');
        
        setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-primary');
        }, 1500);
        
        // Toast notification
        showToast('Chave copiada com sucesso!', 'success');
    } catch (err) {
        console.error('Erro ao copiar:', err);
        showToast('Erro ao copiar chave', 'danger');
    }
}

function deleteRecebimento(id) {
    if (confirm('Tem certeza que deseja excluir este recebimento?\n\nEsta ação não pode ser desfeita.')) {
        // Implementar exclusão via AJAX
        fetch(`/api/recebimento/${id}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Recebimento excluído com sucesso!', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showToast(data.error || 'Erro ao excluir recebimento', 'danger');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            showToast('Erro ao excluir recebimento', 'danger');
        });
    }
}

// Validação da chave de acesso em tempo real
document.addEventListener('DOMContentLoaded', function() {
    const chaveInput = document.getElementById('chave_acesso');
    if (chaveInput) {
        chaveInput.addEventListener('input', function() {
            const chave = this.value;
            const feedback = this.nextElementSibling;
            
            if (chave.length === 44) {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
                feedback.className = 'form-text text-success';
                feedback.innerHTML = '<i class="bi bi-check-circle me-1"></i>Chave de acesso válida!';
            } else if (chave.length > 0) {
                this.classList.remove('is-valid');
                this.classList.add('is-invalid');
                feedback.className = 'form-text text-danger';
                feedback.innerHTML = `<i class="bi bi-exclamation-circle me-1"></i>Faltam ${44 - chave.length} caracteres.`;
            } else {
                this.classList.remove('is-valid', 'is-invalid');
                feedback.className = 'form-text';
                feedback.innerHTML = 'A chave de acesso deve ter exatamente 44 caracteres.';
            }
        });
    }
});

// Função para mostrar toast notifications
function showToast(message, type = 'info') {
    // Criar elemento toast se não existir
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }
    
    const toastId = 'toast-' + Date.now();
    const toastHTML = `
        <div id="${toastId}" class="toast align-items-center text-bg-${type} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHTML);
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
    
    // Remover toast após ser ocultado
    toastElement.addEventListener('hidden.bs.toast', function() {
        toastElement.remove();
    });
}
</script>

<!-- Botão Flutuante -->
<button type="button" class="btn btn-primary floating-add-btn" data-bs-toggle="modal" data-bs-target="#addRecebimentoModal" title="Adicionar Recebimento">
    <i class="bi bi-plus"></i>
</button>

<style>
.floating-add-btn {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: none;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    transition: all 0.3s ease;
}

.floating-add-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
}

.floating-add-btn:active {
    transform: scale(0.95);
}

.floating-add-btn i {
    line-height: 1;
}

/* Estilos Modernos para Modal */
.modern-modal {
    border: none;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
    overflow: hidden;
}

.modern-modal-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border: none;
    padding: 16px 24px 12px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

.modal-icon {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, var(--bs-primary) 0%, #0056b3 100%);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
    color: white;
    font-size: 18px;
}

.modern-modal-header .modal-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #1a1a1a;
    line-height: 1.2;
}

.modern-btn-close {
    background-color: rgba(0, 0, 0, 0.12) !important;
    border-radius: 8px;
    width: 32px;
    height: 32px;
    opacity: 1 !important;
    transition: all 0.2s ease;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    color: rgba(0, 0, 0, 0.7) !important;
}

.modern-btn-close:hover {
    background-color: rgba(0, 0, 0, 0.12) !important;
    opacity: 1 !important;
    transform: scale(1.05);
    color: rgba(0, 0, 0, 0.8) !important;
}

.modern-btn-close:focus {
    box-shadow: 0 0 0 2px rgba(var(--bs-primary-rgb), 0.25);
    opacity: 1 !important;
    background-color: rgba(0, 0, 0, 0.12) !important;
}

.modern-modal-body {
    padding: 20px 24px;
    background: #ffffff;
}

.form-group-modern {
    margin-bottom: 16px;
}

.form-label-modern {
    font-size: 0.875rem;
    font-weight: 600;
    color: #374151;
    margin-bottom: 8px;
    display: block;
    letter-spacing: 0.025em;
}

.form-control-modern {
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 14px 16px;
    font-size: 0.95rem;
    transition: all 0.2s ease;
    background: #ffffff;
    color: #1f2937;
    width: 100%;
}

.form-control-modern:focus {
    border-color: var(--bs-primary);
    box-shadow: 0 0 0 3px rgba(var(--bs-primary-rgb), 0.1);
    outline: none;
    background: #ffffff;
}

.form-control-modern::placeholder {
    color: #9ca3af;
    font-size: 0.9rem;
}

.input-helper {
    font-size: 0.8rem;
    color: #6b7280;
    margin-top: 6px;
    font-style: italic;
}

.modern-modal-footer {
    background: #f9fafb;
    border: none;
    padding: 14px 24px 18px;
    display: flex;
    gap: 12px;
    justify-content: flex-end;
}

.btn-modern {
    border: none;
    border-radius: 10px;
    padding: 12px 24px;
    font-size: 0.9rem;
    font-weight: 600;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    text-decoration: none;
    cursor: pointer;
}

.btn-modern.btn-secondary {
    background: #f3f4f6;
    color: #6b7280;
}

.btn-modern.btn-secondary:hover {
    background: #e5e7eb;
    color: #4b5563;
    transform: translateY(-1px);
}

.btn-modern.btn-primary {
    background: linear-gradient(135deg, var(--bs-primary) 0%, #0056b3 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(var(--bs-primary-rgb), 0.3);
}

.btn-modern.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(var(--bs-primary-rgb), 0.4);
}

.btn-modern.btn-primary:active {
    transform: translateY(0);
    box-shadow: 0 2px 8px rgba(var(--bs-primary-rgb), 0.3);
}

/* Animação de entrada do modal */
.modal.fade .modern-modal {
    transform: scale(0.9) translateY(-20px);
    transition: all 0.3s ease;
}

.modal.show .modern-modal {
    transform: scale(1) translateY(0);
}
</style>

{% endblock %}